<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocketè¿æ¥æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
        }
        .status.connecting {
            background: #fff3cd;
            color: #856404;
        }
        .status.connected {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .status.disconnected {
            background: #d6d8db;
            color: #383d41;
        }
        .info {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .info p {
            margin: 5px 0;
        }
        .log {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #007bff;
            padding-left: 10px;
        }
        .log-entry.success {
            border-color: #28a745;
            color: #28a745;
        }
        .log-entry.error {
            border-color: #dc3545;
            color: #dc3545;
        }
        .log-entry.info {
            border-color: #17a2b8;
            color: #17a2b8;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”Œ WebSocketè¿æ¥æµ‹è¯•</h1>
        
        <div id="status" class="status disconnected">
            âšª æœªè¿æ¥
        </div>
        
        <div class="info">
            <p><strong>ç”¨æˆ·ID:</strong> <span id="userId">-</span></p>
            <p><strong>WebSocket URL:</strong> <span id="wsUrl">-</span></p>
            <p><strong>è¿æ¥æ—¶é—´:</strong> <span id="connectTime">-</span></p>
        </div>
        
        <div>
            <button id="connectBtn" onclick="testConnection()">ğŸ”Œ æµ‹è¯•è¿æ¥</button>
            <button id="disconnectBtn" onclick="disconnect()" disabled>ğŸ”Œ æ–­å¼€è¿æ¥</button>
            <button onclick="sendPing()" id="pingBtn" disabled>ğŸ’“ å‘é€å¿ƒè·³</button>
            <button onclick="clearLog()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
        </div>
        
        <h3>ğŸ“‹ è¿æ¥æ—¥å¿—</h3>
        <div id="log" class="log">
            <div class="log-entry info">ç­‰å¾…æµ‹è¯•è¿æ¥...</div>
        </div>
    </div>

    <script>
        let ws = null;
        let userId = null;
        let wsUrl = null;

        // æ·»åŠ æ—¥å¿—
        function addLog(message, type = 'info') {
            const log = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const time = new Date().toLocaleTimeString();
            entry.textContent = `[${time}] ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        // æ›´æ–°çŠ¶æ€
        function updateStatus(status, message) {
            const statusEl = document.getElementById('status');
            statusEl.className = `status ${status}`;
            statusEl.textContent = message;
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            const log = document.getElementById('log');
            log.innerHTML = '<div class="log-entry info">æ—¥å¿—å·²æ¸…ç©º</div>';
        }

        // è·å–ç”¨æˆ·ä¿¡æ¯
        function getUserInfo() {
            try {
                const userStore = JSON.parse(localStorage.getItem('user') || '{}');
                userId = userStore.info?.userId || userStore.info?.id || userStore.userInfo?.userId || userStore.userInfo?.id;
                
                if (!userId) {
                    addLog('âŒ æœªæ‰¾åˆ°ç”¨æˆ·IDï¼Œè¯·å…ˆç™»å½•ç³»ç»Ÿï¼', 'error');
                    addLog('localStorageä¸­çš„useræ•°æ®: ' + JSON.stringify(userStore), 'error');
                    return false;
                }
                
                document.getElementById('userId').textContent = userId;
                addLog('âœ… è·å–åˆ°ç”¨æˆ·ID: ' + userId, 'success');
                return true;
            } catch (error) {
                addLog('âŒ è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥: ' + error.message, 'error');
                return false;
            }
        }

        // æµ‹è¯•è¿æ¥
        function testConnection() {
            addLog('ğŸš€ å¼€å§‹æµ‹è¯•WebSocketè¿æ¥...', 'info');
            
            // è·å–ç”¨æˆ·ä¿¡æ¯
            if (!getUserInfo()) {
                updateStatus('error', 'âŒ è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥');
                return;
            }

            // æ„å»ºWebSocket URL
            wsUrl = `ws://localhost:29578/ws/notification?userId=${userId}`;
            document.getElementById('wsUrl').textContent = wsUrl;
            addLog('ğŸŒ WebSocket URL: ' + wsUrl, 'info');

            // åˆ›å»ºWebSocketè¿æ¥
            try {
                updateStatus('connecting', 'ğŸŸ¡ æ­£åœ¨è¿æ¥...');
                ws = new WebSocket(wsUrl);

                ws.onopen = () => {
                    const time = new Date().toLocaleString();
                    updateStatus('connected', 'ğŸŸ¢ è¿æ¥æˆåŠŸ');
                    document.getElementById('connectTime').textContent = time;
                    addLog('âœ… WebSocketè¿æ¥æˆåŠŸï¼', 'success');
                    addLog('ğŸ“… è¿æ¥æ—¶é—´: ' + time, 'success');
                    
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    document.getElementById('connectBtn').disabled = true;
                    document.getElementById('disconnectBtn').disabled = false;
                    document.getElementById('pingBtn').disabled = false;
                };

                ws.onmessage = (event) => {
                    addLog('ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: ' + event.data, 'success');
                    try {
                        const data = JSON.parse(event.data);
                        addLog('   è§£æå: ' + JSON.stringify(data, null, 2), 'info');
                    } catch (e) {
                        addLog('   (éJSONæ ¼å¼)', 'info');
                    }
                };

                ws.onerror = (error) => {
                    updateStatus('error', 'âŒ è¿æ¥é”™è¯¯');
                    addLog('âŒ WebSocketé”™è¯¯: ' + error, 'error');
                    console.error('WebSocket Error:', error);
                };

                ws.onclose = (event) => {
                    updateStatus('disconnected', 'âšª è¿æ¥å·²å…³é—­');
                    addLog('ğŸ”Œ è¿æ¥å…³é—­ - ä»£ç : ' + event.code + ', åŸå› : ' + (event.reason || 'æ— '), 'info');
                    
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    document.getElementById('connectBtn').disabled = false;
                    document.getElementById('disconnectBtn').disabled = true;
                    document.getElementById('pingBtn').disabled = true;
                    document.getElementById('connectTime').textContent = '-';
                };

            } catch (error) {
                updateStatus('error', 'âŒ åˆ›å»ºè¿æ¥å¤±è´¥');
                addLog('âŒ åˆ›å»ºWebSocketå¤±è´¥: ' + error.message, 'error');
                console.error('WebSocket Creation Error:', error);
            }
        }

        // æ–­å¼€è¿æ¥
        function disconnect() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                addLog('ğŸ”Œ ä¸»åŠ¨æ–­å¼€è¿æ¥...', 'info');
                ws.close(1000, 'User disconnected');
            }
        }

        // å‘é€å¿ƒè·³
        function sendPing() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const message = { type: 'ping', timestamp: Date.now() };
                ws.send(JSON.stringify(message));
                addLog('ğŸ’“ å‘é€å¿ƒè·³: ' + JSON.stringify(message), 'info');
            } else {
                addLog('âŒ WebSocketæœªè¿æ¥ï¼Œæ— æ³•å‘é€æ¶ˆæ¯', 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶çš„æç¤º
        addLog('ğŸ’¡ æç¤º: è¯·ç¡®ä¿å·²åœ¨ä¸»ç³»ç»Ÿä¸­ç™»å½•', 'info');
        addLog('ğŸ’¡ ç‚¹å‡»"æµ‹è¯•è¿æ¥"æŒ‰é’®å¼€å§‹æµ‹è¯•', 'info');
    </script>
</body>
</html>

